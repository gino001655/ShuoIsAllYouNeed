# 數據集檢查指南

## 生成的檔案

### DLCV Dataset 樣本
已成功生成 3 個樣本：
- `DLCV_sample_00/` - 樣本 0
- `DLCV_sample_01/` - 樣本 1
- `DLCV_sample_02/` - 樣本 2

### PrismLayersPro Dataset
⚠️ 無法生成 PrismLayersPro 樣本，因為 DLCV 數據集不是標準的 PrismLayersPro 格式。
但我們的 `DLCVLayoutDataset` 已經將其轉換為相同的輸出格式。

---

## 每個樣本資料夾包含

### 1. `info.txt` - 樣本資訊
- Dataset 名稱
- 樣本索引
- Caption（描述文字）
- 圖片尺寸
- 圖層總數
- 每層的 Bounding Box

### 2. `overview.png` - 圖層總覽
**最重要！** 一張圖快速看到所有圖層的排列

### 3. 各圖層圖片
- `layer_00_RGBA.png` / `layer_00_RGB.png` - Layer 0（完整圖片）
- `layer_01_RGBA.png` / `layer_01_RGB.png` - Layer 1（背景）
- `layer_02_RGBA.png` / `layer_02_RGB.png` - Layer 2（前景物件 1）
- `layer_03+_RGBA.png` / `layer_03+_RGB.png` - Layer 3+（其他前景物件）

**RGBA vs RGB:**
- **RGBA**: 帶透明度（alpha channel），可以看到透明區域
- **RGB**: 無透明度，透明區域顯示為灰色背景

### 4. `whole_image_original.png` - 原始完整圖片
從數據集中直接讀取的原始圖片（未經處理）

---

## 檢查重點

### ✅ 正確的圖層結構（CLD 訓練格式）

```
Layer 0: Whole Image (完整圖片)
├─ 應該是所有圖層疊加後的完整畫面
└─ 包含背景 + 所有前景物件

Layer 1: Base/Background (背景)
├─ 應該是純背景
├─ 不包含前景物件（文字、圖案、裝飾等）
└─ 可能是純色、漸層或背景圖案

Layer 2+: Foreground Layers (前景圖層)
├─ 每一層包含一個前景物件
├─ 物件應該有透明背景（RGBA）
├─ 物件應該在正確的位置（根據 bbox）
└─ 每層應該只包含該物件，不包含其他物件
```

### ❌ 常見問題檢查

#### 1. **背景層檢查（最重要！）**
**檢查 `layer_01_RGBA.png`:**
- ✅ **正確**: 只有背景（純色、漸層或背景圖案），沒有文字、圖案
- ❌ **錯誤**: 包含完整圖片（與 layer_00 一樣）
- ❌ **錯誤**: 包含前景物件（文字、圖案等）

**如何檢查:**
```
1. 打開 layer_01_RGBA.png
2. 看是否有文字、圖案、裝飾等前景物件
3. 如果有 → 背景提取錯誤！
4. 如果沒有 → 正確！
```

#### 2. **前景圖層檢查**
**檢查 `layer_02+_RGBA.png`:**
- ✅ **正確**: 每層只包含一個物件，周圍是透明的
- ❌ **錯誤**: 包含多個物件
- ❌ **錯誤**: 透明度處理錯誤（有白邊、黑邊）

#### 3. **圖層位置檢查**
**對照 `info.txt` 中的 bbox:**
```
例如: Layer 3: [214, 355, 865, 725]
- 表示物件應該在座標 (214, 355) 到 (865, 725) 的區域內
- 檢查 layer_03_RGBA.png 中物件是否在這個區域
- 周圍應該是透明的
```

#### 4. **完整圖片檢查**
**檢查 `layer_00_RGBA.png`:**
- 應該與 `whole_image_original.png` 相同或非常相似
- 是所有圖層疊加的結果

---

## 快速檢查步驟

### Step 1: 打開 overview.png
```bash
# 在檔案管理器中打開
cd /tmp2/b12902041/Gino/ShuoIsAllYouNeed/Yao/final/CLD/dataset_comparison/DLCV_sample_00
xdg-open overview.png  # Linux
```

快速瀏覽所有圖層的排列

### Step 2: 重點檢查 Layer 0 和 Layer 1
```
layer_00_RGBA.png  →  應該是完整圖片
layer_01_RGBA.png  →  應該是純背景（這是最關鍵的！）
```

### Step 3: 檢查前景圖層
```
layer_02_RGBA.png  →  應該是單一物件 + 透明背景
layer_03_RGBA.png  →  應該是單一物件 + 透明背景
...
```

### Step 4: 對照 info.txt
確認每層的 bbox 與實際圖層位置相符

---

## 判斷標準

### ✅ 通過（可以訓練）
- Layer 1 是純背景（沒有前景物件）
- Layer 2+ 是單一前景物件（帶透明背景）
- 每層的位置與 bbox 相符
- 所有圖層疊加 = Layer 0（完整圖片）

### ❌ 失敗（不能訓練）
- Layer 1 包含前景物件（與完整圖片一樣）
- 前景圖層包含多個物件
- 透明度處理錯誤
- 圖層位置與 bbox 不符

---

## 如果發現問題

### 問題 1: Layer 1 不是純背景
**可能原因:**
- DLCV 數據集中沒有標記 ColoredBackground
- 背景提取邏輯錯誤

**解決方案:**
- 檢查 `dlcv_dataset.py` 中的背景提取邏輯
- 確認是否正確識別 `type == 3` (ColoredBackground)

### 問題 2: 圖層順序錯誤
**可能原因:**
- 圖層順序與預期不符
- 背景圖層沒有被正確放在 Layer 1

**解決方案:**
- 檢查 `dlcv_dataset.py` 中的圖層順序邏輯

### 問題 3: 透明度問題
**可能原因:**
- RGBA 轉換錯誤
- Alpha channel 處理錯誤

**解決方案:**
- 檢查 `rgba2rgb` 函數
- 確認 PIL Image 的 mode 處理

---

## 與 CLD 訓練的關係

### 為什麼圖層結構很重要？

CLD 的訓練目標是學習**從完整圖片中分解出圖層**：

```
輸入:
- 完整圖片 (Layer 0)
- Bounding boxes
- 文字描述

學習目標:
- 生成純背景 (Layer 1)
- 生成各個前景圖層 (Layer 2+)

如果背景不正確 → 模型學到錯誤的分解方式 → 訓練失敗！
```

### 訓練時的 Loss 計算

```python
# 簡化版
predicted_layers = model(whole_image, bboxes, caption)
loss = MSE(predicted_layers, ground_truth_layers)
```

**如果 ground_truth_layers 不正確（例如背景包含前景物件），模型會學到錯誤的東西！**

---

## 總結

**最關鍵的檢查:**
1. ✅ Layer 1 (背景) 是否是純背景？
2. ✅ Layer 2+ (前景) 是否是單一物件 + 透明背景？
3. ✅ 圖層位置是否與 bbox 相符？

**如果以上都正確 → 可以放心訓練！** 🎉

**如果有任何問題 → 需要修正 `dlcv_dataset.py`！** ⚠️

