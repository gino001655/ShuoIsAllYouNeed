# COCO æ ¼å¼è½‰ CLD Parquet æ ¼å¼è½‰æ›è…³æœ¬

## ğŸ“‹ åŠŸèƒ½èªªæ˜

é€™å€‹è…³æœ¬å°‡ COCO æ ¼å¼çš„è³‡æ–™é›†è½‰æ›ç‚º CLD å¯ä»¥ä½¿ç”¨çš„ Parquet æ ¼å¼ã€‚

### è¼¸å…¥æ ¼å¼ï¼ˆCOCOï¼‰

```
preprocessed_data/
â”œâ”€â”€ annotations/
â”‚   â”œâ”€â”€ train.json    # COCO æ ¼å¼çš„è¨“ç·´é›†è¨»è§£
â”‚   â””â”€â”€ val.json      # COCO æ ¼å¼çš„é©—è­‰é›†è¨»è§£
â””â”€â”€ images/
    â”œâ”€â”€ train/        # è¨“ç·´é›†åœ–ç‰‡
    â””â”€â”€ val/          # é©—è­‰é›†åœ–ç‰‡
```

COCO JSON çµæ§‹ï¼š
```json
{
  "images": [
    {
      "id": 0,
      "file_name": "00000000.png",
      "width": 1024,
      "height": 576
    },
    ...
  ],
  "annotations": [
    {
      "id": 1,
      "image_id": 0,
      "category_id": 1,
      "bbox": [x, y, width, height],  // COCO æ ¼å¼ï¼š[x, y, w, h]
      "layer_order": 0.09  // åœ–å±¤é †åºï¼ˆ0.0-1.0ï¼Œå¾èƒŒæ™¯åˆ°å‰æ™¯ï¼‰
    },
    ...
  ]
}
```

### è¼¸å‡ºæ ¼å¼ï¼ˆCLD Parquetï¼‰

```
output_dir/
â””â”€â”€ snapshots/
    â””â”€â”€ snapshot_1/
        â””â”€â”€ data/
            â”œâ”€â”€ train-00000-of-00001.parquet
            â””â”€â”€ val-00000-of-00001.parquet
```

Parquet æª”æ¡ˆåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š
- `preview`: å®Œæ•´åœ–ç‰‡è·¯å¾‘ï¼ˆçµ•å°è·¯å¾‘ï¼‰
- `title`: åœ–ç‰‡æè¿°ï¼ˆé è¨­ç‚º "A design image"ï¼‰
- `left`: åœ–å±¤å·¦ä¸Šè§’ x åº§æ¨™åˆ—è¡¨
- `top`: åœ–å±¤å·¦ä¸Šè§’ y åº§æ¨™åˆ—è¡¨
- `width`: åœ–å±¤å¯¬åº¦åˆ—è¡¨
- `height`: åœ–å±¤é«˜åº¦åˆ—è¡¨
- `length`: åœ–å±¤æ•¸é‡
- `image`: å€‹åˆ¥åœ–å±¤åœ–ç‰‡åˆ—è¡¨ï¼ˆç›®å‰ç‚º Noneï¼‰

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
cd /tmp2/b12902041/Gino/ShuoIsAllYouNeed/Yao/final/CLD
python tools/convert_coco_to_cld.py \
    --input_dir /tmp2/b12902041/Gino/preprocessed_data \
    --output_dir /tmp2/b12902041/Gino/cld_dataset
```

### åƒæ•¸èªªæ˜

- `--input_dir`: COCO æ ¼å¼è³‡æ–™é›†çš„æ ¹ç›®éŒ„ï¼ˆåŒ…å« `annotations/` å’Œ `images/`ï¼‰
- `--output_dir`: è¼¸å‡ºç›®éŒ„ï¼ˆæœƒè‡ªå‹•å»ºç«‹ `snapshots/snapshot_1/data/`ï¼‰
- `--max_samples_per_shard`: æ¯å€‹ Parquet shard çš„æœ€å¤§æ¨£æœ¬æ•¸ï¼ˆé è¨­: 1000ï¼‰

### ç¯„ä¾‹

```bash
# è½‰æ›è³‡æ–™é›†
python tools/convert_coco_to_cld.py \
    --input_dir /tmp2/b12902041/Gino/preprocessed_data \
    --output_dir /tmp2/b12902041/Gino/cld_dataset \
    --max_samples_per_shard 2000
```

## âœ… è³‡æ–™é©—è­‰èˆ‡æª¢æŸ¥

è…³æœ¬æœƒè‡ªå‹•é€²è¡Œä»¥ä¸‹æª¢æŸ¥ï¼š

### 1. æ ¼å¼é©—è­‰
- âœ… æª¢æŸ¥ COCO JSON æ ¼å¼æ˜¯å¦æ­£ç¢º
- âœ… æª¢æŸ¥å¿…è¦çš„æ¬„ä½æ˜¯å¦å­˜åœ¨
- âœ… æª¢æŸ¥ bbox æ ¼å¼æ˜¯å¦ç‚º `[x, y, w, h]`

### 2. é †åºæª¢æŸ¥
- âœ… æŒ‰ `layer_order` æ’åº annotationsï¼ˆå¾èƒŒæ™¯åˆ°å‰æ™¯ï¼‰
- âœ… æª¢æŸ¥ `layer_order` æ˜¯å¦åœ¨ `[0.0, 1.0]` ç¯„åœå…§
- âœ… æª¢æŸ¥æ˜¯å¦æœ‰é‡è¤‡çš„ `layer_order`ï¼ˆæœƒè­¦å‘Šä½†ç¹¼çºŒè™•ç†ï¼‰

### 3. é‚Šç•Œæª¢æŸ¥
- âœ… ç¢ºä¿ bbox åº§æ¨™åœ¨åœ–ç‰‡ç¯„åœå…§
- âœ… è‡ªå‹•ä¿®æ­£è¶…å‡ºé‚Šç•Œçš„åº§æ¨™
- âœ… ç¢ºä¿å¯¬åº¦å’Œé«˜åº¦ç‚ºæ­£æ•¸
- âœ… è½‰æ›ç‚ºæ•´æ•¸åº§æ¨™ï¼ˆå››æ¨äº”å…¥ï¼‰

### 4. åº§æ¨™è½‰æ›
- âœ… COCO æ ¼å¼ `[x, y, w, h]` â†’ CLD æ ¼å¼ `[x, y, x+w, y+h]`
- âœ… ä¸éœ€è¦æ­¸ä¸€åŒ–ï¼ˆä½¿ç”¨åƒç´ åº§æ¨™ï¼‰
- âœ… ç¢ºä¿ `x+w <= width`, `y+h <= height`

### 5. åœ–ç‰‡é©—è­‰
- âœ… æª¢æŸ¥åœ–ç‰‡æª”æ¡ˆæ˜¯å¦å­˜åœ¨
- âœ… é©—è­‰åœ–ç‰‡å°ºå¯¸æ˜¯å¦èˆ‡ JSON ä¸­çš„å°ºå¯¸ä¸€è‡´
- âœ… å¦‚æœå°ºå¯¸ä¸åŒ¹é…ï¼Œä½¿ç”¨å¯¦éš›åœ–ç‰‡å°ºå¯¸

## ğŸ“Š è¼¸å‡ºè³‡è¨Š

è½‰æ›éç¨‹ä¸­æœƒé¡¯ç¤ºï¼š

1. **è¼‰å…¥è³‡è¨Š**ï¼š
   - è¼‰å…¥çš„åœ–ç‰‡æ•¸é‡
   - è¼‰å…¥çš„è¨»è§£æ•¸é‡

2. **è½‰æ›çµ±è¨ˆ**ï¼š
   - æˆåŠŸè½‰æ›çš„æ¨£æœ¬æ•¸
   - éŒ¯èª¤æ•¸é‡
   - è­¦å‘Šæ•¸é‡

3. **è­¦å‘Šè³‡è¨Š**ï¼ˆå‰ 10 å€‹ï¼‰ï¼š
   - æ²’æœ‰è¨»è§£çš„åœ–ç‰‡
   - layer_order ç¯„åœå•é¡Œ
   - é‡è¤‡çš„ layer_order
   - å°ºå¯¸ä¸åŒ¹é…
   - ç„¡æ•ˆçš„ bbox

4. **éŒ¯èª¤è³‡è¨Š**ï¼ˆå‰ 20 å€‹ï¼‰ï¼š
   - åœ–ç‰‡æª”æ¡ˆä¸å­˜åœ¨
   - bbox æ ¼å¼éŒ¯èª¤
   - å…¶ä»–è™•ç†éŒ¯èª¤

## ğŸ” è½‰æ›å¾Œçš„è³‡æ–™æ ¼å¼

è½‰æ›å¾Œçš„ Parquet æª”æ¡ˆå¯ä»¥ç›´æ¥è¢« `CustomLayoutDataset` ä½¿ç”¨ï¼š

```python
from tools.custom_dataset import CustomLayoutDataset

# ä½¿ç”¨è½‰æ›å¾Œçš„è³‡æ–™
dataset = CustomLayoutDataset(
    data_dir="/tmp2/b12902041/Gino/cld_dataset",
    split="train"
)

# æª¢æŸ¥è³‡æ–™
item = dataset[0]
print(f"Caption: {item['caption']}")
print(f"å°ºå¯¸: {item['width']}x{item['height']}")
print(f"åœ–å±¤æ•¸: {len(item['layout'])}")
print(f"Layout: {item['layout']}")
```

## âš ï¸ é‡è¦æ³¨æ„äº‹é …

### 1. Layer Info éœ€æ±‚

**CLD åªéœ€è¦ Bounding Boxï¼Œä¸éœ€è¦ Layer æ•¸å­—ï¼**

- âœ… éœ€è¦ï¼šBounding Box `[w0, h0, w1, h1]`ï¼ˆå·¦ä¸Šè§’ã€å³ä¸‹è§’åº§æ¨™ï¼‰
- âŒ ä¸éœ€è¦ï¼šLayer ç´¢å¼•æˆ–æ•¸å­—
- âš ï¸ é‡è¦ï¼š**é †åºä»£è¡¨åœ–å±¤é †åº**ï¼ˆå¾èƒŒæ™¯åˆ°å‰æ™¯ï¼‰

### 2. Layout æ ¼å¼

CLD çš„ layout æ ¼å¼ï¼š
```python
layout = [
    [0, 0, W-1, H-1],      # ç¬¬ 0 å€‹ï¼šæ•´å€‹ç•«å¸ƒï¼ˆå¿…é ˆï¼‰
    [0, 0, W-1, H-1],      # ç¬¬ 1 å€‹ï¼šèƒŒæ™¯ï¼ˆé€šå¸¸ä¹Ÿæ˜¯æ•´å€‹ç•«å¸ƒï¼‰
    [x1, y1, x2, y2],      # ç¬¬ 2 å€‹ï¼šç¬¬ä¸€å€‹å‰æ™¯åœ–å±¤
    [x3, y3, x4, y4],      # ç¬¬ 3 å€‹ï¼šç¬¬äºŒå€‹å‰æ™¯åœ–å±¤
    ...
]
```

### 3. åº§æ¨™ç³»çµ±

- **ä¸éœ€è¦æ­¸ä¸€åŒ–**ï¼šä½¿ç”¨åƒç´ åº§æ¨™ï¼ˆæ•´æ•¸ï¼‰
- **COCO æ ¼å¼**ï¼š`[x, y, w, h]`ï¼ˆå·¦ä¸Šè§’ + å¯¬é«˜ï¼‰
- **CLD æ ¼å¼**ï¼š`[x, y, x+w, y+h]`ï¼ˆå·¦ä¸Šè§’ + å³ä¸‹è§’ï¼‰
- **è‡ªå‹•é‡åŒ–**ï¼šCLD æœƒè‡ªå‹•å°‡åº§æ¨™é‡åŒ–åˆ° 16 çš„å€æ•¸

### 4. é †åºé‡è¦æ€§

- åœ–å±¤é †åºå¾ˆé‡è¦ï¼Œå¾èƒŒæ™¯åˆ°å‰æ™¯
- ç¬¬ä¸€å€‹åœ–å±¤é€šå¸¸æ˜¯æ•´å€‹ç•«å¸ƒ
- ç¬¬äºŒå€‹åœ–å±¤é€šå¸¸æ˜¯èƒŒæ™¯
- å¾ŒçºŒåœ–å±¤æ˜¯å‰æ™¯å…ƒç´ ï¼ˆæŒ‰ `layer_order` æ’åºï¼‰

## ğŸ› å¸¸è¦‹å•é¡Œ

### Q: è½‰æ›å¾Œæ‰¾ä¸åˆ°åœ–ç‰‡ï¼Ÿ

A: æª¢æŸ¥ `preview` æ¬„ä½ä¸­çš„è·¯å¾‘æ˜¯å¦æ­£ç¢ºã€‚è…³æœ¬ä½¿ç”¨çµ•å°è·¯å¾‘ï¼Œç¢ºä¿åœ–ç‰‡æª”æ¡ˆå­˜åœ¨ã€‚

### Q: layer_order æœ‰é‡è¤‡æ€éº¼è¾¦ï¼Ÿ

A: è…³æœ¬æœƒè­¦å‘Šä½†ç¹¼çºŒè™•ç†ï¼Œä½¿ç”¨æ’åºå¾Œçš„é †åºï¼ˆPython çš„ç©©å®šæ’åºï¼‰ã€‚

### Q: bbox è¶…å‡ºåœ–ç‰‡ç¯„åœï¼Ÿ

A: è…³æœ¬æœƒè‡ªå‹•ä¿®æ­£ï¼Œç¢ºä¿åº§æ¨™åœ¨æœ‰æ•ˆç¯„åœå…§ã€‚

### Q: å¦‚ä½•é©—è­‰è½‰æ›çµæœï¼Ÿ

A: ä½¿ç”¨ä»¥ä¸‹ä»£ç¢¼æª¢æŸ¥ï¼š

```python
from tools.custom_dataset import CustomLayoutDataset

dataset = CustomLayoutDataset(data_dir="output_dir", split="train")
print(f"è³‡æ–™é›†å¤§å°: {len(dataset)}")

# æª¢æŸ¥ç¬¬ä¸€ç­†è³‡æ–™
item = dataset[0]
print(f"Caption: {item['caption']}")
print(f"å°ºå¯¸: {item['width']}x{item['height']}")
print(f"åœ–å±¤æ•¸: {len(item['layout'])}")
print(f"Layout: {item['layout'][:3]}...")  # é¡¯ç¤ºå‰ 3 å€‹
```

## ğŸ“ è½‰æ›æµç¨‹ç¸½çµ

1. **è®€å– COCO JSON** â†’ è¼‰å…¥åœ–ç‰‡å’Œè¨»è§£è³‡è¨Š
2. **æŒ‰ image_id åˆ†çµ„** â†’ å°‡è¨»è§£åˆ†çµ„åˆ°å°æ‡‰çš„åœ–ç‰‡
3. **æŒ‰ layer_order æ’åº** â†’ ç¢ºä¿åœ–å±¤é †åºæ­£ç¢º
4. **è½‰æ› bbox æ ¼å¼** â†’ `[x, y, w, h]` â†’ `[x, y, x+w, y+h]`
5. **é©—è­‰å’Œä¿®æ­£** â†’ æª¢æŸ¥é‚Šç•Œã€å°ºå¯¸ã€æœ‰æ•ˆæ€§
6. **å»ºç«‹ Parquet** â†’ å„²å­˜ç‚º CLD å¯ç”¨çš„æ ¼å¼

## ğŸ¯ ä½¿ç”¨è½‰æ›å¾Œçš„è³‡æ–™

åœ¨ `train.yaml` æˆ– `infer.yaml` ä¸­è¨­ç½®ï¼š

```yaml
data_dir: "/tmp2/b12902041/Gino/cld_dataset"
```

ç„¶å¾Œæ­£å¸¸ä½¿ç”¨ï¼š

```bash
# è¨“ç·´
python -m train.train -c train/train.yaml

# æ¨è«–
python -m infer.infer -c infer/infer.yaml
```


